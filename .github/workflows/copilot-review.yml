name: Copilot PR Review

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-review-on-pr:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Request Copilot PR review
        uses: actions/github-script@v7
        env:
          COPILOT_REVIEWER: ${{ vars.COPILOT_REVIEWER || 'Copilot' }}
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;
            if (pr.draft) return;

            const { owner, repo } = context.repo;
            const pull_number = pr.number;
            const reviewer = process.env.COPILOT_REVIEWER;
            const marker = '<!-- copilot-auto-review-fallback -->';

            try {
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number,
                reviewers: [reviewer],
              });
            } catch (err) {
              core.warning(`Unable to request reviewer ${reviewer}: ${err.message}`);

              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number: pull_number,
                per_page: 100,
              });
              const alreadyPosted = comments.some((c) =>
                c.user?.login === 'github-actions[bot]' && c.body?.includes(marker)
              );
              if (alreadyPosted) return;

              const body = [
                marker,
                `Automatic Copilot review request could not be created for reviewer \`${reviewer}\`.`,
                'Please request **Copilot** from the PR Reviewers menu, or comment as a human with `@copilot review`.',
              ].join('\n\n');

              await github.rest.issues.createComment({ owner, repo, issue_number: pull_number, body });
            }
